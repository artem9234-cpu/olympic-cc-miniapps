<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–†—É–ª–µ—Ç–∫–∞ –ª—É—á—à–∏—Ö</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f5f7fb;
      padding: 20px;
      text-align: center;
    }
    h2 {
      color: #2d3e50;
      margin: 20px 0 30px;
    }
    #wheel {
      width: 280px;
      height: 280px;
      margin: 0 auto 30px;
      position: relative;
      border-radius: 50%;
      background: #fff;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .spinner {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      font-size: 16px;
      color: #666;
    }
    #result {
      display: none;
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin: 20px auto;
      max-width: 400px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .person {
      text-align: left;
      padding: 12px 0;
      border-bottom: 1px solid #eee;
    }
    .person:last-child { border: none; }
    .name { font-weight: bold; color: #2d3e50; }
    .metric { font-size: 14px; color: #666; margin-top: 4px; }
    button {
      background: #50a8eb;
      color: white;
      border: none;
      padding: 14px 28px;
      font-size: 18px;
      border-radius: 10px;
      cursor: pointer;
      margin-top: 10px;
    }
    button:disabled { opacity: 0.6; }
    .loading { color: #888; font-size: 14px; margin-top: 10px; }
  </style>
</head>
<body>
  <h2>üé° –†—É–ª–µ—Ç–∫–∞ –ª—É—á—à–∏—Ö</h2>
  
  <div id="wheel">
    <div class="spinner">–ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ...</div>
  </div>

  <button id="spinBtn">üîÑ –ö—Ä—É—Ç–∏—Ç—å —Ä—É–ª–µ—Ç–∫—É</button>
  <div id="status" class="loading"></div>

  <div id="result"></div>

  <script>
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbzXlZgA7Wdl9Rw3wlRSDfXUBSdaUVIcQ70TlwfVTbyT8y1rFsjXriUCT0r799AHnDIjuw/exec';
    const wheel = document.getElementById('wheel');
    const spinBtn = document.getElementById('spinBtn');
    const status = document.getElementById('status');
    const resultDiv = document.getElementById('result');

    // –ü—Ä–æ—Å—Ç–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –≤—Ä–∞—â–µ–Ω–∏—è
    function spinAnimation() {
      wheel.innerHTML = `<div class="spinner">–ö—Ä—É—Ç–∏–º...<br>–ñ–¥–∏—Ç–µ üåÄ</div>`;
      wheel.style.transition = 'transform 3s cubic-bezier(0.2, 0.8, 0.4, 1)';
      const rotations = 5 + Math.random() * 3;
      wheel.style.transform = `rotate(${rotations * 360}deg)`;
    }

    // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –ø–æ–∫–∞–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    function showResult(data) {
      setTimeout(() => {
        wheel.style.transition = 'none';
        wheel.style.transform = 'rotate(0deg)';
        wheel.innerHTML = `<div class="spinner">‚úÖ –ì–æ—Ç–æ–≤–æ!</div>`;
        
        let html = '';
        data.forEach(item => {
          html += `
            <div class="person">
              <div class="name">üë§ ${item.name}</div>
              <div class="metric">üìû –ó–≤–æ–Ω–∫–∏: ${item.calls}</div>
              <div class="metric">‚è± –û–±—Ä–∞–±–æ—Ç–∫–∞: ${item.aht}</div>
              <div class="metric">‚ùå –ü—Ä–æ–ø—É—â–µ–Ω–æ: ${item.missed}</div>
              <div class="metric">‚≠ê –ö–∞—á–µ—Å—Ç–≤–æ: ${item.quality}</div>
            </div>
          `;
        });
        resultDiv.innerHTML = html;
        resultDiv.style.display = 'block';
        spinBtn.disabled = false;
      }, 3100);
    }

    spinBtn.addEventListener('click', async () => {
      spinBtn.disabled = true;
      status.textContent = '–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ...';

      try {
        spinAnimation();

        const res = await fetch(`${GAS_URL}?action=spin`);
        const json = await res.json();

        if (json.success) {
          status.textContent = '–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º...';
          showResult(json.data);
        } else {
          throw new Error(json.error || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
        }
      } catch (err) {
        console.error(err);
        status.textContent = '‚ùå –û—à–∏–±–∫–∞: ' + (err.message || '–Ω–µ—Ç —Å–≤—è–∑–∏');
        spinBtn.disabled = false;
        wheel.innerHTML = `<div class="spinner">‚ö†Ô∏è –û—à–∏–±–∫–∞</div>`;
        wheel.style.transform = 'rotate(0deg)';
      }
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
    if (window.Telegram?.WebApp) {
      Telegram.WebApp.ready();
      Telegram.WebApp.expand();
    }
  </script>
</body>
</html>
