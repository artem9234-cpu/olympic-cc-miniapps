<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üé° –†—É–ª–µ—Ç–∫–∞ –ª—É—á—à–∏—Ö</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --primary: #8A2BE2; /* —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π */
      --accent: #87CEFA;  /* –≥–æ–ª—É–±–æ–π */
      --bg: #0f0c29;
      --gold: #FFD700;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
      color: white;
      font-family: 'Segoe UI', system-ui, sans-serif;
      padding: 16px;
      min-height: 100vh;
      overflow: hidden;
      position: relative;
    }
    /* –û–≥–æ–Ω—å–∫–∏ –ø–æ –∫—Ä–∞—è–º */
    .lights {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none;
      z-index: -1;
    }
    .light {
      position: absolute;
      width: 8px; height: 8px;
      border-radius: 50%;
      box-shadow: 0 0 12px var(--accent), 0 0 24px var(--gold);
      animation: twinkle 3s infinite ease-in-out;
    }
    @keyframes twinkle {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 1; transform: scale(1.2); }
    }
    h1 {
      text-align: center;
      font-size: 28px;
      margin: 20px 0 10px;
      text-shadow: 0 0 10px var(--gold), 0 0 20px var(--accent);
      font-weight: 800;
    }
    .subtitle {
      text-align: center;
      color: #ccc;
      font-size: 14px;
      margin-bottom: 20px;
    }

    /* –ë–∞—Ä–∞–±–∞–Ω —Ä—É–ª–µ—Ç–∫–∏ */
    #wheel-container {
      position: relative;
      width: 280px;
      height: 280px;
      margin: 0 auto 24px;
      border-radius: 50%;
      overflow: hidden;
      box-shadow: 
        0 0 0 4px rgba(255,215,0,0.3),
        0 0 20px rgba(135,206,250,0.6),
        inset 0 0 12px rgba(0,0,0,0.8);
    }
    #wheel {
      width: 100%; height: 100%;
      position: relative;
      transition: transform 4s cubic-bezier(0.2, 0.8, 0.3, 1);
      background: rgba(15, 12, 41, 0.9);
    }
    .slot {
      position: absolute;
      width: 100%; height: 20%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 14px;
      text-shadow: 0 1px 2px rgba(0,0,0,0.8);
    }
    .slot:nth-child(odd) { background: rgba(138, 43, 226, 0.3); }
    .slot:nth-child(even) { background: rgba(135, 206, 250, 0.2); }

    /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä "STOP" */
    .indicator {
      position: absolute;
      top: -20px; left: 50%;
      transform: translateX(-50%);
      width: 0; height: 0;
      border-left: 12px solid transparent;
      border-right: 12px solid transparent;
      border-bottom: 24px solid var(--gold);
      z-index: 10;
    }
    .indicator::after {
      content: '‚èπ';
      position: absolute;
      top: 8px; left: -6px;
      font-size: 12px;
    }

    /* –†–µ–∑—É–ª—å—Ç–∞—Ç */
    #result {
      display: none;
      background: rgba(25, 20, 60, 0.85);
      border: 2px solid var(--gold);
      border-radius: 16px;
      padding: 20px;
      margin: 20px auto;
      max-width: 400px;
      box-shadow: 0 0 16px rgba(255, 215, 0, 0.5);
    }
    .winner {
      text-align: center;
      padding: 16px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .winner:last-child { border: none; }
    .name {
      font-size: 20px;
      font-weight: bold;
      color: var(--gold);
      margin-bottom: 6px;
    }
    .medal { font-size: 18px; margin-right: 6px; }
    .metric {
      font-size: 13px;
      color: #ddd;
      margin: 3px 0;
    }

    /* –ö–Ω–æ–ø–∫–∞ */
    button {
      background: linear-gradient(45deg, var(--primary), #6a0dad);
      color: white;
      border: none;
      padding: 16px 32px;
      font-size: 18px;
      font-weight: bold;
      border-radius: 50px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(138, 43, 226, 0.4);
      transition: all 0.2s;
      margin-top: 10px;
    }
    button:hover:not(:disabled) {
      transform: scale(1.03);
      box-shadow: 0 6px 16px rgba(138, 43, 226, 0.6);
    }
    button:active { transform: scale(0.98); }
    button:disabled {
      opacity: 0.7;
      cursor: wait;
    }

    .status {
      color: #aaa;
      font-size: 14px;
      margin-top: 12px;
      min-height: 20px;
    }

    /* –ó–≤—ë–∑–¥—ã –ø–æ–∑–∞–¥–∏ */
    .stars {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none;
      z-index: -2;
    }
    .star {
      position: absolute;
      background: white;
      border-radius: 50%;
      animation: pulse 2s infinite alternate;
    }
    @keyframes pulse {
      from { opacity: 0.2; transform: scale(0.8); }
      to { opacity: 1; transform: scale(1.1); }
    }
  </style>
</head>
<body>
  <div class="stars" id="stars"></div>
  <div class="lights" id="lights"></div>

  <h1>üé° –†—É–ª–µ—Ç–∫–∞ –ª—É—á—à–∏—Ö</h1>
  <p class="subtitle">–ö–æ–ª–ª-—Ü–µ–Ω—Ç—Ä ¬´–û–ª–∏–º–ø–∏–π—Å–∫–∏–π¬ª</p>

  <div id="wheel-container">
    <div class="indicator"></div>
    <div id="wheel">
      <!-- –ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ JS -->
    </div>
  </div>

  <button id="spinBtn">‚ñ∂Ô∏è –ö—Ä—É—Ç–∏—Ç—å —Ä—É–ª–µ—Ç–∫—É!</button>
  <div class="status" id="status">–ì–æ—Ç–æ–≤—ã –∫ —Ä–æ–∑—ã–≥—Ä—ã—à—É?</div>

  <div id="result"></div>

  <!-- –ê—É–¥–∏–æ -->
  <audio id="spinSound" src="assets/spin.mp3" preload="auto"></audio>
  <audio id="winSound" src="assets/win.mp3" preload="auto"></audio>

  <script>
    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–≤—ë–∑–¥ –∏ –æ–≥–æ–Ω—å–∫–æ–≤ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ —Ñ–æ–Ω–∞
    function createDecor() {
      const stars = document.getElementById('stars');
      const lights = document.getElementById('lights');
      
      // 50 –∑–≤—ë–∑–¥
      for (let i = 0; i < 50; i++) {
        const star = document.createElement('div');
        star.className = 'star';
        star.style.left = `${Math.random() * 100}%`;
        star.style.top = `${Math.random() * 100}%`;
        star.style.width = `${Math.random() * 3 + 1}px`;
        star.style.height = star.style.width;
        star.style.animationDelay = `${Math.random() * 3}s`;
        stars.appendChild(star);
      }
      
      // 30 –æ–≥–æ–Ω—å–∫–æ–≤
      for (let i = 0; i < 30; i++) {
        const light = document.createElement('div');
        light.className = 'light';
        light.style.left = `${Math.random() * 100}%`;
        light.style.top = `${Math.random() * 100}%`;
        light.style.animationDelay = `${Math.random() * 5}s`;
        lights.appendChild(light);
      }
    }

    // –°–æ–∑–¥–∞—ë–º –¥–µ–∫–æ—Ä –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    createDecor();

    const GAS_URL = 'https://script.google.com/macros/s/AKfycbyl5Hznm8XX1tAimXy1F-Y0dkE8kt9h9ysJN8LHHH9qs4NrQlEdRu863oKf3UW2aeS1Iw/exec';
    const wheel = document.getElementById('wheel');
    const spinBtn = document.getElementById('spinBtn');
    const status = document.getElementById('status');
    const resultDiv = document.getElementById('result');
    const spinSound = document.getElementById('spinSound');
    const winSound = document.getElementById('winSound');

    let isSpinning = false;

    // –ó–∞–ø–æ–ª–Ω—è–µ–º –±–∞—Ä–∞–±–∞–Ω –∑–∞–≥–ª—É—à–∫–∞–º–∏ (–±—É–¥–µ—Ç –∑–∞–º–µ–Ω–µ–Ω–æ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏)
    function fillWheel(names = ['–ì–æ—Ç–æ–≤–∏–º—Å—è...', '–ö—Ä—É—Ç–∏–º!', '–°–∫–æ—Ä–æ!', '–ñ–¥—ë–º!', '–í–∂—É—Ö!']) {
      wheel.innerHTML = '';
      names.forEach((name, i) => {
        const slot = document.createElement('div');
        slot.className = 'slot';
        slot.style.transform = `rotate(${i * 72}deg) translateY(-120px) rotate(${-i * 72}deg)`;
        slot.innerText = name;
        wheel.appendChild(slot);
      });
    }

    fillWheel();

    // –ó–∞–ø—Ä–æ—Å –∫ GAS
    async function fetchWinners() {
      try {
        const res = await fetch(`${GAS_URL}?action=spin`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        if (!data.success) throw new Error(data.error || '–û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö');
        return data.data;
      } catch (err) {
        console.error('Fetch error:', err);
        throw err;
      }
    }

    // –ê–Ω–∏–º–∞—Ü–∏—è –≤—Ä–∞—â–µ–Ω–∏—è
    function spinAnimation() {
      spinSound.currentTime = 0;
      spinSound.play().catch(e => console.warn('Audio play failed:', e));
      
      wheel.style.transition = 'transform 5s cubic-bezier(0.1, 0.9, 0.3, 1)';
      const rotations = 8 + Math.random() * 4; // 8-12 –æ–±–æ—Ä–æ—Ç–æ–≤
      wheel.style.transform = `rotate(${rotations * 360}deg)`;
    }

    // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –ø–æ–∫–∞–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    async function showResult(winners) {
      await new Promise(resolve => setTimeout(resolve, 5100)); // –¥–æ–∂–∏–¥–∞–µ–º—Å—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏

      winSound.currentTime = 0;
      winSound.play().catch(e => console.warn('Win sound failed:', e));

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–º–µ–Ω–∞ –≤ –±–∞—Ä–∞–±–∞–Ω–µ
      fillWheel(winners.map(w => `üèÜ ${w.name}`));

      // –§–æ—Ä–º–∏—Ä—É–µ–º HTML —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
      let html = '';
      winners.forEach(w => {
        html += `
          <div class="winner">
            <div class="name"><span class="medal">üèÖ</span>${w.name}</div>
            <div class="metric">üìû –ó–≤–æ–Ω–∫–∏: ${w.calls}</div>
            <div class="metric">‚è± –û–±—Ä–∞–±–æ—Ç–∫–∞: ${w.aht}</div>
            <div class="metric">‚ùå –ü—Ä–æ–ø—É—â–µ–Ω–æ: ${w.missed}</div>
            <div class="metric">‚≠ê –ö–∞—á–µ—Å—Ç–≤–æ: ${w.quality}</div>
          </div>
        `;
      });
      resultDiv.innerHTML = html;
      resultDiv.style.display = 'block';

      spinBtn.disabled = false;
      status.textContent = 'üéâ –ü–æ–±–µ–¥–∏—Ç–µ–ª–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã!';
      isSpinning = false;
    }

    // –û—Å–Ω–æ–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
    spinBtn.addEventListener('click', async () => {
      if (isSpinning) return;
      isSpinning = true;
      spinBtn.disabled = true;
      status.textContent = '–ö—Ä—É—Ç–∏–º –±–∞—Ä–∞–±–∞–Ω... üî•';

      try {
        const winners = await fetchWinners();
        fillWheel(winners.map(w => w.name));
        spinAnimation();
        showResult(winners);
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞:', err);
        status.textContent = '‚ùå –û—à–∏–±–∫–∞: ' + (err.message || '—Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
        fillWheel();
        spinBtn.disabled = false;
        isSpinning = false;
      }
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram
    if (window.Telegram?.WebApp) {
      Telegram.WebApp.ready();
      Telegram.WebApp.expand();
    }
  </script>
</body>
</html>
